name: CI

on:
  push:
    branches: [main]
    paths-ignore:
      - "**.md"
      - "docs/**"
      - "LICENSE"
      - ".gitignore"
  pull_request:
    branches: [main]
    paths-ignore:
      - "**.md"
      - "docs/**"
      - "LICENSE"
      - ".gitignore"

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  test:
    name: Test on macOS
    runs-on: macos-latest
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Cache SPM dependencies
        uses: actions/cache@v4
        with:
          path: |
            .build
            ~/Library/Developer/Xcode/DerivedData/**/SourcePackages
          key: ${{ runner.os }}-spm-${{ hashFiles('**/Package.resolved', '**/Package.swift') }}
          restore-keys: |
            ${{ runner.os }}-spm-

      - name: Show Xcode version
        run: xcodebuild -version

      - name: Show Swift version
        run: swift --version

      - name: Build package
        run: swift build -v

      - name: Run tests
        run: swift test -v

  build-ios:
    name: Build for iOS
    runs-on: macos-latest
    timeout-minutes: 20
    if: >
      contains(github.event.head_commit.modified, 'Sources/RKUtilsUI/') ||
      contains(github.event.head_commit.modified, 'Sources/RKUtilsSwiftUI/') ||
      contains(github.event.head_commit.modified, 'Package.swift') ||
      github.event_name == 'pull_request'

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Cache SPM dependencies
        uses: actions/cache@v4
        with:
          path: |
            .build
            ~/Library/Developer/Xcode/DerivedData/**/SourcePackages
          key: ${{ runner.os }}-spm-${{ hashFiles('**/Package.resolved', '**/Package.swift') }}
          restore-keys: |
            ${{ runner.os }}-spm-

      - name: Select iOS simulator destination
        run: |
          # Get highest iOS runtime (identifier + version)
          RUNTIME_INFO=$(xcrun simctl list runtimes --json | jq -r '.runtimes[]
            | select(.identifier | test("com.apple.CoreSimulator.SimRuntime.iOS"))
            | "\(.identifier)|\(.version)"' | sort -t'|' -k2 -Vr | head -n1)

          if [ -z "$RUNTIME_INFO" ]; then
            echo "ERROR: No iOS runtimes found"
            exit 1
          fi

          RUNTIME_ID=${RUNTIME_INFO%%|*}
          RUNTIME_VERSION=${RUNTIME_INFO##*|}

          echo "Highest iOS runtime detected: $RUNTIME_VERSION (id: $RUNTIME_ID)"

          # Choose first available iPhone device for that runtime
          DEVICE_INFO=$(xcrun simctl list devices --json | jq -r --arg rid "$RUNTIME_ID" '
            (.devices[$rid] // [])[]
            | select(.isAvailable == true)
            | select(.name | test("iPhone"))
            | "\(.udid)|\(.name)"' | head -n1)

          if [ -z "$DEVICE_INFO" ]; then
            echo "ERROR: No available iPhone simulator found for runtime $RUNTIME_ID"
            exit 1
          fi

          DEVICE_UDID=${DEVICE_INFO%%|*}
          DEVICE_NAME=${DEVICE_INFO##*|}

          echo "Selected simulator: $DEVICE_NAME (udid: $DEVICE_UDID, iOS $RUNTIME_VERSION)"

          # Store for display
          echo "SELECTED_DEVICE=$DEVICE_NAME" >> $GITHUB_ENV
          echo "SELECTED_IOS=$RUNTIME_VERSION" >> $GITHUB_ENV

      - name: Build for iOS
        run: |
          echo "Building for iOS (${{ env.SELECTED_IOS }}) with device: ${{ env.SELECTED_DEVICE }}"
          # Build to verify iOS compatibility
          xcodebuild build \
            -scheme RKUtilsUI \
            -sdk iphonesimulator \
            -destination "platform=iOS Simulator,name=${{ env.SELECTED_DEVICE }}"

  build-macos:
    name: Build for macOS
    runs-on: macos-latest
    timeout-minutes: 20
    if: >
      contains(github.event.head_commit.modified, 'Sources/RKUtilsMacOSUI/') ||
      contains(github.event.head_commit.modified, 'Package.swift') ||
      github.event_name == 'pull_request'

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Cache SPM dependencies
        uses: actions/cache@v4
        with:
          path: |
            .build
            ~/Library/Developer/Xcode/DerivedData/**/SourcePackages
          key: ${{ runner.os }}-spm-${{ hashFiles('**/Package.resolved', '**/Package.swift') }}
          restore-keys: |
            ${{ runner.os }}-spm-

      - name: Build for macOS
        run: |
          echo "Building for macOS"
          # Build to verify macOS compatibility
          xcodebuild build \
            -scheme RKUtilsMacOS \
            -sdk macosx \
            -destination "platform=macOS"

  build-linux:
    name: Build for Linux
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Swift
        uses: swift-actions/setup-swift@v2
        with:
          swift-version: "6.0"

      - name: Cache SPM dependencies
        uses: actions/cache@v4
        with:
          path: .build
          key: ${{ runner.os }}-spm-${{ hashFiles('**/Package.resolved', '**/Package.swift') }}
          restore-keys: |
            ${{ runner.os }}-spm-

      - name: Show Swift version
        run: swift --version

      - name: Build RKUtils (cross-platform target)
        run: |
          echo "Building RKUtils target for Linux"
          swift build --product RKUtils -v

      - name: Run RKUtils tests
        run: |
          echo "Running RKUtils tests on Linux"
          swift test --filter RKUtilsTests

  validate:
    name: Package Validation
    runs-on: macos-latest
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Validate Package.swift
        run: |
          # Validate Package.swift manifest syntax
          swift package dump-package > /dev/null
          echo "âœ… Package.swift is valid"

      - name: Resolve dependencies
        run: |
          # Resolve and validate dependencies
          swift package resolve
          echo "âœ… Dependencies resolved"

      - name: Show dependency tree
        run: |
          # Display resolved dependency graph
          swift package show-dependencies

  summary:
    name: Build Summary
    runs-on: macos-latest
    needs: [test, build-ios, build-macos, build-linux, validate]
    if: always() && !cancelled()

    steps:
      - name: Generate summary
        run: |
          echo "## RKUtils CI Results ðŸŽ‰" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Build Information" >> $GITHUB_STEP_SUMMARY
          echo "- **Workflow**: ${{ github.workflow }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Triggered by**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Results" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Tests (124 tests) | ${{ needs.test.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| iOS Build | ${{ needs.build-ios.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| macOS Build | ${{ needs.build-macos.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Linux Build | ${{ needs.build-linux.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Package Validation | ${{ needs.validate.result }} |" >> $GITHUB_STEP_SUMMARY
